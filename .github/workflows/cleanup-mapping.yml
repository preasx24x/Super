name: Clean Expired Mappings

on:
  schedule:
    - cron: '0 * * * *'  # Runs every hour
  workflow_dispatch:     # Allows manual trigger

jobs:
  clean:
    runs-on: ubuntu-latest
    steps:
      - name: Clean expired mappings
        uses: actions/github-script@v6
        with:
          github-token: ghp_dummy  # Not used; real token is fetched in script
          script: |
            const tokenGistUrl = 'https://gist.githubusercontent.com/Preasx24/137f29d4b3b32c251bf6b7ab2b3fae28/raw/gistfile1.txt';
            const token = (await fetch(tokenGistUrl).then(r => r.text())).split('\n')[0].trim();

            const { Octokit } = require("@octokit/rest");
            const octokit = new Octokit({ auth: token });

            const gists = await octokit.gists.list();
            const mappingGist = gists.data.find(g => g.files["gistfile1.txt"]);
            if (!mappingGist) throw new Error("Mapping Gist not found!");

            const raw = await fetch(mappingGist.files["gistfile1.txt"].raw_url).then(r => r.text());
            const mapping = JSON.parse(raw);

            const now = Math.floor(Date.now() / 1000);
            const expires = mapping._expires || {};
            let updated = false;

            for (const key of Object.keys(expires)) {
              expires[key] -= 3600;  // Subtract 1 hour
              if (expires[key] <= now) {
                console.log(`ðŸ—‘ Removing expired entry: ${key}`);
                delete expires[key];
                delete mapping[key];
                updated = true;
              }
            }

            if (updated) {
              mapping._expires = expires;

              await octokit.gists.update({
                gist_id: mappingGist.id,
                files: {
                  "gistfile1.txt": {
                    content: JSON.stringify(mapping, null, 2)
                  }
                }
              });

              console.log("âœ… Updated Gist with cleaned mapping.");
            } else {
              console.log("â„¹ï¸ No expired entries to remove.");
            }