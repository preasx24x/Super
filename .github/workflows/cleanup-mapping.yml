name: Cleanup Gist Mapping

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup expired entries in Gist
        uses: actions/github-script@v6
        with:
          github-token: 'ghp_dummy'  # Required input, but not used
          script: |
            const fetch = require('node-fetch');

            const tokenGistUrl = 'https://gist.githubusercontent.com/Preasx24/137f29d4b3b32c251bf6b7ab2b3fae28/raw/gistfile1.txt';
            const token = (await fetch(tokenGistUrl).then(r => r.text())).split('\n')[0].trim();

            const { Octokit } = require("@octokit/rest");
            const octokit = new Octokit({ auth: token });

            const gists = await octokit.gists.list();
            const mappingGist = gists.data.find(g => g.files["gistfile1.txt"]);
            if (!mappingGist) throw new Error("Mapping Gist not found!");

            const raw = await fetch(mappingGist.files["gistfile1.txt"].raw_url).then(r => r.text());
            const mapping = JSON.parse(raw);

            const now = Math.floor(Date.now() / 1000);
            for (const key of Object.keys(mapping._expires || {})) {
              mapping._expires[key] -= 3600;
              if (mapping._expires[key] <= now) {
                delete mapping._expires[key];
                delete mapping[key];
              }
            }

            await octokit.gists.update({
              gist_id: mappingGist.id,
              files: {
                "gistfile1.txt": {
                  content: JSON.stringify(mapping, null, 2)
                }
              }
            });

            console.log("âœ… Cleaned up expired entries.");